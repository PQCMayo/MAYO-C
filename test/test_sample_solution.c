// SPDX-License-Identifier: Apache-2.0

/**
 * Test case for sample_solution failing in crypto_sign.
 */
#include <api.h>
#include <mem.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <randombytes.h>

static int test_sample_solution(void) {

#if CRYPTO_BYTES == 454 // MAYO-1
    unsigned char entropy_input[48] = { 0xbf, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
#elif CRYPTO_BYTES == 186 // MAYO-2
    unsigned char entropy_input[48] = { 0x33, 0x34, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
#elif CRYPTO_BYTES == 681 // MAYO-3
    unsigned char entropy_input[48] = { 0xdb, 0x15, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
#elif CRYPTO_BYTES == 964 // MAYO-5
    unsigned char entropy_input[48] = { 0x87, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
#else
    #error "variant not supported"
#endif

    size_t msglen = 32;
    size_t smlen = CRYPTO_BYTES + msglen;

    unsigned char *pk  = calloc(CRYPTO_PUBLICKEYBYTES, 1);
    unsigned char *sk  = calloc(CRYPTO_SECRETKEYBYTES, 1);

    unsigned char *sig = calloc(smlen, 1);

    unsigned char msg[32];
    unsigned char msgOpen[32] = { 0 };

    int res = 0;
    randombytes_init(entropy_input, NULL, 256);

    for (int i = 0; i < 32; i++) {
        msg[i] = i;
    }

    res = crypto_sign_keypair(pk, sk);
    if (res) {
        printf("crypto_sign_keypair failed\n");
        goto err;
    }

    res = crypto_sign(sig, &smlen, msg, msglen, sk);

    if (res) {
        printf("crypto_sign failed\n");
        goto err;
    }

    res = crypto_sign_open(msgOpen, &msglen, sig, smlen, pk);
    if (res || memcmp(msg, msgOpen, msglen)) {
        printf("crypto_sign_open failed\n");
        res = -1;
        goto err;
    }

err:
    free(pk);
    mayo_secure_free(sk, CRYPTO_SECRETKEYBYTES);
    free(sig);
    return res;
}

int main(int argc, char *argv[]) {
    return test_sample_solution();
}

